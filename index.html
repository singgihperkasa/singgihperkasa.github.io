<script>
  // Konfigurasi
  let currentSurahNumber = 1;
  let currentAyahNumber = null;
  let currentQori = 'Alafasy_128kbps'; // Sesuaikan dengan nama folder di EveryAyah
  let bookmarks = JSON.parse(localStorage.getItem('quran-bookmarks')) || [];
  let currentSurahData = null;
  let currentAyahIndex = 0;
  let audioQueue = [];

  // DOM Elements
  const htmlRoot = document.getElementById('html-root');
  const darkModeToggle = document.getElementById('dark-mode-toggle');
  const qoriSelect = document.getElementById('qori-select');
  const surahSelect = document.getElementById('surah-select');
  const prevBtn = document.getElementById('prev-surah');
  const nextBtn = document.getElementById('next-surah');
  const bookmarkBtn = document.getElementById('bookmark-toggle');

  // Load saved dark mode
  if (localStorage.getItem('dark-mode') === 'true') {
    document.body.classList.add('dark-mode');
    darkModeToggle.textContent = 'â˜€ï¸ Mode Terang';
  }

  // Toggle dark mode
  darkModeToggle.addEventListener('click', () => {
    document.body.classList.toggle('dark-mode');
    const isDark = document.body.classList.contains('dark-mode');
    localStorage.setItem('dark-mode', isDark);
    darkModeToggle.textContent = isDark ? 'â˜€ï¸ Mode Terang' : 'ðŸŒ™ Mode Malam';
  });

  // Ganti qori
  qoriSelect.addEventListener('change', (e) => {
    currentQori = e.target.value;
    if (currentAyahNumber) {
      playAudio(currentAyahNumber);
    }
  });

  // Navigasi surah
  prevBtn.addEventListener('click', () => {
    if (currentSurahNumber > 1) {
      loadSurah(--currentSurahNumber);
    }
  });

  nextBtn.addEventListener('click', () => {
    if (currentSurahNumber < 114) {
      loadSurah(++currentSurahNumber);
    }
  });

  // Bookmark toggle
  bookmarkBtn.addEventListener('click', () => {
    if (!currentAyahNumber) return;

    const key = `${currentSurahNumber}-${currentAyahNumber}`;
    if (bookmarks.includes(key)) {
      bookmarks = bookmarks.filter(b => b !== key);
      bookmarkBtn.textContent = 'ðŸ”– Simpan Ayat Ini';
    } else {
      bookmarks.push(key);
      bookmarkBtn.textContent = 'âœ… Tersimpan!';
      setTimeout(() => bookmarkBtn.textContent = 'ðŸ”– Simpan Ayat Ini', 1500);
    }
    localStorage.setItem('quran-bookmarks', JSON.stringify(bookmarks));
  });

  function updateBookmarkButton(surahNum, ayahNum) {
    currentAyahNumber = ayahNum;
    const key = `${surahNum}-${ayahNum}`;
    bookmarkBtn.textContent = bookmarks.includes(key) ? 'âœ… Tersimpan!' : 'ðŸ”– Simpan Ayat Ini';
  }

  // === Fungsi Utama ===

  async function loadSurahList() {
    try {
      const res = await fetch('https://api.alquran.cloud/v1/meta'); // âœ… tanpa spasi
      const data = await res.json();
      const surahs = data.data.surahs.references;

      surahSelect.innerHTML = '';
      surahs.forEach(surah => {
        const option = document.createElement('option');
        option.value = surah.number;
        option.textContent = `${surah.number}. ${surah.englishName} (${surah.name})`;
        surahSelect.appendChild(option);
      });

      surahSelect.value = currentSurahNumber;
      loadSurah(currentSurahNumber);
    } catch (err) {
      console.error('Gagal memuat daftar surah:', err);
      document.getElementById('quran-content').innerHTML = '<p style="text-align:center;color:red;">Gagal memuat data. Periksa koneksi internet.</p>';
    }
  }

  async function loadSurah(surahNumber) {
    currentSurahNumber = parseInt(surahNumber);
    surahSelect.value = currentSurahNumber;
    
    prevBtn.disabled = currentSurahNumber === 1;
    nextBtn.disabled = currentSurahNumber === 114;

    try {
      const res = await fetch(`https://api.alquran.cloud/v1/surah/${surahNumber}/id.indonesian`); // âœ… tanpa spasi
      const data = await res.json();
      currentSurahData = data.data;
      renderSurah();
    } catch (err) {
      console.error('Gagal memuat surah:', err);
      document.getElementById('quran-content').innerHTML = '<p style="text-align:center;color:red;">Gagal memuat surah. Coba lagi nanti.</p>';
    }
  }

  function renderSurah() {
    const container = document.getElementById('quran-content');
    container.innerHTML = '';

    currentSurahData.ayahs.forEach(ayah => {
      const verseDiv = document.createElement('div');
      verseDiv.className = 'verse';

      const verseNumber = document.createElement('span');
      verseNumber.className = 'verse-number';
      verseNumber.textContent = ayah.numberInSurah;
      verseNumber.onclick = () => {
        playAudio(ayah.number);
        updateBookmarkButton(currentSurahNumber, ayah.numberInSurah);
      };

      const verseText = document.createElement('div');
      verseText.className = 'verse-text';
      verseText.textContent = ayah.text;

      const translation = document.createElement('div');
      translation.className = 'translation';
      translation.textContent = ayah.edition.text;

      verseDiv.appendChild(verseNumber);
      verseDiv.appendChild(verseText);
      verseDiv.appendChild(translation);
      container.appendChild(verseDiv);
    });

    audioQueue = currentSurahData.ayahs.map(ayah => ayah.number);
  }

  function playAudio(ayahNumber) {
    const audioPlayer = document.getElementById('audio-player');
    // âœ… Sesuaikan nama folder qori dengan yang ada di EveryAyah
    const audioUrl = `https://everyayah.com/data/${currentQori}/${String(ayahNumber).padStart(3, '0')}.mp3`;
    audioPlayer.src = audioUrl;
    audioPlayer.play().catch(e => console.warn("Gagal memutar audio:", e));
  }

  document.getElementById('play-all').addEventListener('click', () => {
    currentAyahIndex = 0;
    playNextAudio();
  });

  function playNextAudio() {
    if (currentAyahIndex >= audioQueue.length) return;

    const ayahNumber = audioQueue[currentAyahIndex];
    const audioPlayer = document.getElementById('audio-player');
    const audioUrl = `https://everyayah.com/data/${currentQori}/${String(ayahNumber).padStart(3, '0')}.mp3`; // âœ… tanpa spasi

    audioPlayer.src = audioUrl;
    audioPlayer.onended = () => {
      currentAyahIndex++;
      playNextAudio();
    };
    audioPlayer.play().catch(e => {
      console.warn("Gagal memutar audio:", e);
      currentAyahIndex++;
      playNextAudio();
    });
  }

  surahSelect.addEventListener('change', (e) => {
    loadSurah(e.target.value);
  });

  // Inisialisasi
  loadSurahList();
</script>
